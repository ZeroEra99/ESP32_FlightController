@startuml esp32_loop_flowchart

title ESP32 Main Loop Flowchart

start
:Leggi dati dall'IMU;
if (Lettura IMU riuscita?) then (Si)
  :Aggiorna ImuData in Aircraft;
else (No)
  :Registra errore IMU;
endif

:Leggi dati dal Receiver;
if (Lettura Receiver riuscita?) then (Si)
  :Aggiorna ReceiverData in Aircraft;
else (No)
  :Registra errore Receiver;
endif

:Verifica stato del sistema;
if (Errori presenti?) then (Si)
  :Aggiorna stato in Failsafe o Manuale;
endif

:Aggiorna modalita' operative;
:Elabora dati con FlightController;
if (Modalita' Manuale?) then (Si)
  :Passa i dati della ricevente agli attuatori;
else
  if (Modalita' Stabilizzazione Giroscopica?) then (Si)
    :Calcola output PID per velocita' angolare;
  else if (Modalita' Controllo Assetto?) then (Si)
    :Calcola setpoint Quaternion;
    :Calcola output PID per controllo assetto;
  endif
endif

:Scrivi dati agli attuatori;
if (Errore critico?) then (Si)
  :Applica parametri di emergenza agli attuatori;
else
  if (Sistema Disarmed?) then (Si)
    :Blocca output agli attuatori;
  else
    :Applica output calcolato;
  endif
endif

:Aggiorna stato LED;

:Inserisci dati nei buffer del Logger;

stop

@enduml
